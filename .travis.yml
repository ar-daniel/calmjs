sudo: false
matrix:
  allow_failures:
    # While the code here is good, travis as of now still do not have
    # first class support for Python, so not going to rely on this yet.
    - os: osx
  include:
    - language: python
      python: 2.7
      addons:
    - language: python
      python: 3.3
      addons:
    - language: python
      python: 3.4
      addons:
    - language: python
      python: 3.5
      addons:
    - language: python
      python: pypy
      addons:
    # test different versions of Node.js on osx
    - language: node_js
      node_js: 4.5
      os: osx
      env: PY_VER=3.4.5
    - language: node_js
      node_js: 6.5
      os: osx
      env: PY_VER=3.5.2

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew update || brew update ;
      brew install pyenv ;
      brew outdated pyenv || brew upgrade pyenv ;
      pyenv install $PY_VER ;
      pyenv global $PY_VER ;
      pyenv rehash ;
      python -m pip install --user virtualenv ;
      python -m virtualenv ~/.venv ;
      source ~/.venv/bin/activate ;
    fi

install:
  - pip install nose coverage flake8
  - python setup.py develop
script: 
  - flake8 setup.py src
  # with pypy version >= 2.5.0 (maybe earlier, definitely after 2.2.1),
  # coverage fails to produce meaningful results running with nose.
  # Check that and only use nose (which is only somewhat useful only
  # when errors happen) with CPython.  This happened on the prior
  # changeset (ee599b4d) where checks and testing with callbacks that
  # lead to recursive calling of functions were added.
  - if [[ $TRAVIS_PYTHON_VERSION == pypy* ]]; then
      coverage run --include=src/* -m unittest calmjs.tests.make_suite ;
      coverage report -m ;
    else
      nosetests --with-coverage --cover-package=calmjs --with-doctest ;
    fi
# Alternatively without nose
after_success:
  # only submit coverage when testing under linux.
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      pip install coveralls ;
      coveralls ;
    fi
branches:
  only:
    - testing
    - master
    - 1.0.x
